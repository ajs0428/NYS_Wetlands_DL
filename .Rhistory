}
# r_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#     rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
# }
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
#
# return(list(f_list, v_list, m_list))
}
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
m_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
}
return(list(f_list, v_list, m_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
files_vects_rasts
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, v_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
gc()
terraOptions(memfrac = 0.10,
tempdir = "/ibstorage/anthony/NYS_Wetlands_GHG/Data/tmp")
files_vects_rasts
files_vects_rasts[[2]]
r <- files_vects_rasts[[2]]
r[[1]]
lr <- lapply(r, terra::wrap)
lr <- lapply(r, terra::unwrap)
lr[[1]]
plot9lr[[1]])
plot(lr[[1]])
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
r <- files_vects_rasts[[2]]
lr <- lapply(r, terra::unwrap)
r
lr[[3]]
lr
unlist(lr)
?unlist
unlist(lr, recursive = F)
lr
unlist(r)
unlist(r, recursive = FALSE)
unlist(r) == unlist(r, recursive = FALSE)
l.ex <- list(a = list(1:5, LETTERS[1:5]), b = "Z", c = NA)
unlist(l.ex, recursive = FALSE)
unlist(l.ex, recursive = TRUE)
lr
str(lr)
str(r)
lr[[1]]
unlist(lr[[1]])
lr[[1]]
unlist(lr, recursive = TRUE)
unlist(lr, recursive = FALSE)
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(
lapply(lapply(
lapply(as.list(f_list[[i]]), terra::rast),
terra::project, y = terra::crs("EPSG:6350")), terra::merge),
terra::wrap
)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
r
r[[1]]
lr <- lapply(r[[1]], terra::unwrap)
lr
lr[1:5]
terra::merge(lr[1:5])
terra::plot(lr[1:5])
terra::plot(lr[1])
plot(lr[[1]])
lr[[1:5]]
lr[1:5]
unlist(lr[1:5])
sprc(lr[1:5])
terra::merge(sprc(lr[1:5]))
plot(terra::merge(sprc(lr[1:5])))
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(
terra::sprc(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350"))),
terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
gc()
stopCluster(cl)
terraOptions(memfrac = 0.10,
tempdir = "/ibstorage/anthony/NYS_Wetlands_GHG/Data/tmp")
cl <- makeCluster(8)
registerDoParallel(cl)
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(
terra::sprc(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350"))),
terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
vect("FieldData/Wet_Val_Pts_20250820/Garmin_GPSMap65s_wet_val_20250820.shp")
terra::vect("FieldData/Wet_Val_Pts_20250820/Garmin_GPSMap65s_wet_val_20250820.shp")
terra::vect("FieldData/Wet_Val_Pts_20250820/Survey123_wet_val_20250820.shp")
library(terra)
v <- vect("Data/NY_HUCS/NY_Cluster_Zones_200.gpkg")
v |> filter(cluster == 208)
v |> tidyterra::filter(cluster == 208)
v
unique(v$cluster)
v <- vect("Data/NY_HUCS/NY_Cluster_Zones_200.gpkg")
unique(v$cluster)
v |> tidyterra::filter(cluster == 208)
v208 <- v |> tidyterra::filter(cluster == 208)
writeVector(v208, "Data/NY_HUCS/Cluster208.gpkg")
writeVector(v208, "Data/NY_HUCS/Cluster208.shp")
v208
v208 |> terra::aggregate()
v208 |> terra::aggregate() |> writeVector("Data/NY_HUCS/Cluster208.shp", overwrite = TRUE)
plot(v208)
v208 |> terra::aggregate() |> plot()
v208 |> terra::aggregate() |> terra::simplifyGeom() |> plot()
?simplifyGeom
v208 |> terra::aggregate() |> terra::simplifyGeom(tolerance = 0.5) |> plot()
v208 |> terra::aggregate() |> terra::simplifyGeom(tolerance = 0.9) |> plot()
v208 |> terra::aggregate() |> terra::simplifyGeom(tolerance = 10) |> plot()
ext(v208) |> writeVector("Data/NY_HUCS/Cluster208ext.shp", overwrite = TRUE)
vect(ext(v208), crs = crs(v208)) |> writeVector("Data/NY_HUCS/Cluster208ext.shp", overwrite = TRUE)
v
vh <- v[stringr::str_detect(v$huc12, "041402011002")]
ch
vh
plot(vh)
terra::simplifyGeom(vh)
terra::simplifyGeom(vh) |> plot()
terra::simplifyGeom(vh, tolerance = 10) |> plot()
terra::simplifyGeom(vh, tolerance = 100) |> plot()
terra::simplifyGeom(vh, tolerance = 1000) |> plot()
terra::simplifyGeom(vh, tolerance = 200) |> plot()
terra::simplifyGeom(vh, tolerance = 100) |> plot()
vhs <- terra::simplifyGeom(vh, tolerance = 100)
writeVector(vhs, "Data/NY_HUCS/HUC_041402011002.shp")
mtcars
```{r}
mtcars
mtcars
mtcars
#| label: setup
library(terra)
library(sf)
library(tidyverse)
v <- vect("Data/NWI/wet_polys_small.gpkg")
plot(v, "WETLAND_TY")
vs <- st_read("Data/NWI/wet_polys_small.gpkg")
plot(vs["WETLAND_TY"])
vs_p <- sf::st_sample(vs, 100)
plot(vs_p)
?st_sample
vs_p <- sf::st_sample(vs, 10, by_polygon = TRUE)
plot(vs_p)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE)
plot(vs_p)
vs_p <- sf::st_sample(vs, 100, by_polygon = FALSE)
plot(vs_p)
vs_p <- sf::st_sample(vs, 100, by_polygon = FALSE)
plot(vs_p)
vs_p
set.seed(11)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE)
vs_p
plot(vs_p)
set.seed(11)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE)
vs_p
plot(vs_p)
vs_pf <- sf::st_sample(vs, 100, by_polygon = FALSE)
vs_pf
plot(vs_pf)
plot(c(vs, vs_p))
set.seed(11)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE)
vs_p
plot(vs)
plot(vs_p, add = TRUE)
vs_pf <- sf::st_sample(vs, 100, by_polygon = FALSE)
vs_pf
plot(vs_pf)
set.seed(11)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE)
vs_p
plot(vs["WETLAND_TY"], legend = F)
plot(vs_p, add = TRUE)
vs_pf <- sf::st_sample(vs, 100, by_polygon = FALSE)
vs_pf
plot(vs_pf)
plot(vs["WETLAND_TY"], key.position = NULL)
plot(vs["WETLAND_TY"], key.position = NULL)
plot(vs_p, add = TRUE)
plot(vs["WETLAND_TY"], key.position = NULL)
plot(vs_p, add = TRUE)
plot(vs_p, add = TRUE)
plot(st_geometry(vs))
plot(vs_p, add = TRUE)
plot(vs["WETLAND_TY"], key.pos = NA)
plot(vs["WETLAND_TY"], key.pos = NULL)
plot(vs_p, add = TRUE)
vs_p
plot(vs["WETLAND_TY"], key.pos = NULL)
plot(vs["WETLAND_TY"], key.pos = NULL)
plot(st_geometry(vs), key.pos = NULL)
plot(vs_p, add = T)
plot(st_geometry(vs), key.pos = NULL)
plot(vs_p, add = T)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE, crs = "EPSG:6347")
vs_p
plot(st_geometry(vs), key.pos = NULL)
vs_pa <- st_join(vs_p, vs["WETLAND_TY"])
?st_join
vs_pa <- st_join(vs_p, vs["WETLAND_TY"], join = "st_intersects")
vs_pa <- st_intersects(vs_p, vs["WETLAND_TY"], join = "st_intersects")
vs_pa
vs_pa <- st_intersects(vs_p, vs["WETLAND_TY"])
vs_pa
vs_pa[1]
set.seed(11)
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE, crs = "EPSG:6347")
vs_p
plot(st_geometry(vs), key.pos = NULL)
vs_pa <- st_intersects(vs_p, vs)
vs_pa[1]
vs_pa
vs_pa <- st_intersects(vs_p, vs, sparse = F)
vs_pa[1]
vs_pa
vs_pa <- st_intersects(vs_p, vs)
vs_pa
vs_p <- sf::st_sample(vs, 100, c(1,2,3), by_polygon = TRUE, crs = "EPSG:6347")
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE, crs = "EPSG:6347")
vs_p <- sf::st_sample(vs, 100, by_polygon = TRUE, crs = "EPSG:6347")
vs_p
names(vs_p)
vs_pa <- st_join(vs_p, vs)
vs_p <- sf::st_sample(vs, 100, exact = TRUE, crs = "EPSG:6347")
vs_p
plot(st_geometry(vs), key.pos = NULL)
vs_pa <- st_join(vs_p, vs)
vs_pa
vs_p
vs_p <- sf::st_sample(vs, 100, exact = TRUE)
vs_p
vs_pa <- st_join(vs_p, vs)
names(vs)
class(vs)
vs_pa <- st_join(vs, vs_p)
vs_pa <- st_join(st_geometry(vs_p), vs)
vs_pa <- st_join(st_as_sf(vs_p), vs)
vs_pa
vs_p <- sf::st_sample(vs, 5, exact = TRUE)
vs_p
vs_p <- sf::st_sample(vs, 5, exact = TRUE, by_polygon = TRUE)
vs_p
vs
set.seed(11)
vs_p <- sf::st_sample(vs, 5, exact = TRUE, by_polygon = TRUE)
vs_p
vs
seq(1, 80,10)
vs_p <- sf::st_sample(vs, seq(1, 80,10), exact = TRUE, by_polygon = TRUE)
vs_p
rep(10, 8)
vs_p <- sf::st_sample(vs, rep(10, 8), exact = TRUE, by_polygon = TRUE)
vs_p
vs_p <- sf::st_sample(vs, rep(10, 8), exact = TRUE, by_polygon = FALSE)
vs_p
plot(vs_p)
vs_p <- sf::st_sample(vs, rep(10, 8), exact = TRUE, by_polygon = TRUE)
vs_p
plot(vs_p)
vs_p <- sf::st_sample(vs, rep(5, 8), exact = TRUE, by_polygon = TRUE)
vs_p
plot(vs_p)
vs_p <- sf::st_sample(vs, rep(5, 8), exact = TRUE, by_polygon = FALSE)
vs_p
plot(vs_p)
vs_p
vs_p <- sf::st_sample(vs, rep(5, nrow(vs)), exact = TRUE)
vs_p
vs_p <- sf::st_sample(vs, 5, exact = TRUE)
vs_p
plot(vs_p)
plot(st_geometry(vs))
plot(c(st_geometry(vs), st_geometry(vs_pa)))
vs_p
p_
left_join(st_drop_geometry(vs), count(st_drop_geometry(vs_p)))
count(st_drop_geometry(vs_p)
)
st_drop_geometry(vs)
st_drop_geometry(vs_p)
vs_p <- sf::st_sample(vs, 5, exact = TRUE) |>
st_sf()
vs_p
vs_p <- sf::st_sample(vs, 5, exact = TRUE) |>
st_sf() |>
st_join(vs)
vs_p
left_join(st_drop_geometry(vs), count(st_drop_geometry(vs_p)), ATTRIBUTE, name = "pt_count")
vs_p <- sf::st_sample(vs, 5, exact = TRUE) |>
st_sf() |>
st_join(vs[,"ATTRIBUTE"])
vs_p
plot(c(st_geometry(vs), st_geometry(vs_pa)))
left_join(
st_drop_geometry(vs),
count(st_drop_geometry(vs_p), ID, name = "point_count")
)
left_join(
st_drop_geometry(vs),
count(st_drop_geometry(vs_p), ATTRIBUTE, name = "point_count")
)
plot(c(st_geometry(vs), st_geometry(vs_pa)))
vs_p <- sf::st_sample(vs, 5, exact = TRUE) |>
st_sf() |>
st_join(vs[,"ATTRIBUTE"])
vs_p
plot(c(st_geometry(vs), st_geometry(vs_p)))
vs_p <- sf::st_sample(vs, 10, exact = TRUE) |>
st_sf() |>
st_join(vs[,"ATTRIBUTE"])
vs_p
plot(c(st_geometry(vs), st_geometry(vs_p)))
left_join(
st_drop_geometry(vs),
count(st_drop_geometry(vs_p), ATTRIBUTE, name = "point_count")
)
st_drop_geometry(vs_p)
st_drop_geometry(vs)
vs_p <- sf::st_sample(vs, 10, exact = TRUE) |>
st_sf() |>
st_join(vs[,"Shape_Leng"])
vs_p
plot(c(st_geometry(vs), st_geometry(vs_p)))
left_join(
st_drop_geometry(vs),
count(st_drop_geometry(vs_p), Shape_Leng, name = "point_count")
)
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf() |>
st_join(vs[,"Shape_Leng"])
vs_p
plot(c(st_geometry(vs), st_geometry(vs_p)))
left_join(
st_drop_geometry(vs),
count(st_drop_geometry(vs_p), Shape_Leng, name = "point_count")
)
sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf()
sf::st_sample(vs, 1000, exact = TRUE)
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
#st_sf() |>
st_join(vs[,"Shape_Leng"])
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf() |>
st_join(vs[,"Shape_Leng"], name = "TEST")
vs_p
sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf()
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf(agr = "identity") |>
st_join(vs[,"Shape_Leng"])
sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf(agr = "identity")
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf(agr = "identity") |>
dplyr::rename("geom")
?dplyr::rename
"geom"
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf(agr = "identity") |>
dplyr::rename_with("geom")
vs_p <- sf::st_sample(vs, 1000, exact = TRUE) |>
st_sf(agr = "identity") |>
st_set_geometry("geom") |>
st_join(vs[,"Shape_Leng"])
vs_p
?version
version()
version
R.version$os
plot(0)
package_version("quarto")
packageVersion("quarto")
