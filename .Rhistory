r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
m_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
}
return(list(f_list, v_list, m_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
#
# return(list(f_list, v_list, m_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
# r_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#     rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
# }
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
#
# return(list(f_list, v_list, m_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
# A shapefile list of all the DEM indexes (vector tiles of the actual DEM locations)
dem_ind_list <- (lapply(list.files(args[1], pattern = ".shp$",full.names = TRUE), sf::st_read))
transform_sf <- function(stl){
new_stl <- list()
for(i in seq_along(stl)){
if(crs(stl[[i]]) != st_crs("EPSG:6350")){
new_stl[[i]] <- st_transform(stl[[i]], st_crs("EPSG:6350"))
} else {
new_stl[[i]] <- stl[[i]]
}
}
return(new_stl)
}
dem_ind_trs <- transform_sf(dem_ind_list)
# This should just output a summary for the collections
for(i in dem_ind_trs) {print(st_crs(i)$input)}
###############################################################################################
# This is all the DEM file names
dems_file_list <- list.files(args[4],
pattern = ".img$|.tif$",
full.names = TRUE,
recursive = TRUE,
include.dirs = TRUE)
print(paste0("this is the total list of DEM indexes: ", length(dems_file_list)[[1]]))
# This takes the vector file of all HUC watersheds, projects them, and filters for the cluster
# of interest.
# cluster_target is all the HUCs in a cluster
cluster_target <- sf::st_read(args[2]) |>
sf::st_transform(st_crs("EPSG:6350")) |>
dplyr::filter(cluster == args[3])
cluster_extract <- function(cluster, dem_indexes){
files_to_extract <- list()
for(i in seq_along(dem_indexes)){
dems_in <- dem_indexes[[i]] |> st_filter(y = cluster, .predicate = st_intersects)
if(nrow(dems_in) > 1){
Fnames <- dems_in["FILENAME"][[1]]
files_to_extract <- append(files_to_extract, Fnames)
} else {
next
}
}
return(files_to_extract)
}
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
# r_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#     rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
# }
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
#
# return(list(f_list, v_list, m_list))
}
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
m_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
}
return(list(f_list, v_list, m_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
files_vects_rasts
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, v_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
gc()
terraOptions(memfrac = 0.10,
tempdir = "/ibstorage/anthony/NYS_Wetlands_GHG/Data/tmp")
files_vects_rasts
files_vects_rasts[[2]]
r <- files_vects_rasts[[2]]
r[[1]]
lr <- lapply(r, terra::wrap)
lr <- lapply(r, terra::unwrap)
lr[[1]]
plot9lr[[1]])
plot(lr[[1]])
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350")), terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
r <- files_vects_rasts[[2]]
lr <- lapply(r, terra::unwrap)
r
lr[[3]]
lr
unlist(lr)
?unlist
unlist(lr, recursive = F)
lr
unlist(r)
unlist(r, recursive = FALSE)
unlist(r) == unlist(r, recursive = FALSE)
l.ex <- list(a = list(1:5, LETTERS[1:5]), b = "Z", c = NA)
unlist(l.ex, recursive = FALSE)
unlist(l.ex, recursive = TRUE)
lr
str(lr)
str(r)
lr[[1]]
unlist(lr[[1]])
lr[[1]]
unlist(lr, recursive = TRUE)
unlist(lr, recursive = FALSE)
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(
lapply(lapply(
lapply(as.list(f_list[[i]]), terra::rast),
terra::project, y = terra::crs("EPSG:6350")), terra::merge),
terra::wrap
)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
r
r[[1]]
lr <- lapply(r[[1]], terra::unwrap)
lr
lr[1:5]
terra::merge(lr[1:5])
terra::plot(lr[1:5])
terra::plot(lr[1])
plot(lr[[1]])
lr[[1:5]]
lr[1:5]
unlist(lr[1:5])
sprc(lr[1:5])
terra::merge(sprc(lr[1:5]))
plot(terra::merge(sprc(lr[1:5])))
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(
terra::sprc(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350"))),
terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
gc()
stopCluster(cl)
terraOptions(memfrac = 0.10,
tempdir = "/ibstorage/anthony/NYS_Wetlands_GHG/Data/tmp")
cl <- makeCluster(8)
registerDoParallel(cl)
#Take the list of dems_to_extract and go by each HUC to merge into a full raster
# should return a list of rasters that can be merged again
huc_extract <- function(cluster){
f_list <- list()
v_list <- list()
for(i in seq_along(cluster$huc12)){
dem_to_extr <- cluster_extract(cluster = cluster[i, ], dem_indexes = dem_ind_trs)
f_list[[i]] <- dems_file_list[basename(dems_file_list) %in% dem_to_extr]
v_list[[i]] <- terra::vect(cluster[i,]) |>
terra::project(crs("EPSG:6350")) |> terra::wrap()
}
r_list <- foreach(i = seq_along(cluster$huc12),
.packages = c("terra", "tidyterra", "sf")) %dopar% {
rs <- lapply(
terra::sprc(lapply(lapply(as.list(f_list[[i]]), terra::rast), terra::project, y = terra::crs("EPSG:6350"))),
terra::wrap)
}
# m_list <- foreach(i = seq_along(cluster$huc12),
#                   .packages = c("terra", "tidyterra", "sf")) %dopar% {
#         masked <- terra::mask(x = terra::merge(lapply(r_list[[i]], terra::unwrap)),
#                     mask = terra::unwrap(v_list[[i]]), updatevalue=NA, touches = TRUE)
# }
return(list(f_list, r_list))
}
cluster_target3 <- cluster_target[1:3]
files_vects_rasts <- huc_extract(cluster = cluster_target3)
vect("FieldData/Wet_Val_Pts_20250820/Garmin_GPSMap65s_wet_val_20250820.shp")
terra::vect("FieldData/Wet_Val_Pts_20250820/Garmin_GPSMap65s_wet_val_20250820.shp")
terra::vect("FieldData/Wet_Val_Pts_20250820/Survey123_wet_val_20250820.shp")
